# GitHub Copilot Context - Kurz Service

This file provides context for GitHub Copilot when working on the kurz URL redirect service.

## Project Context

This is `kurz` - a lightweight URL redirect service that powers short URLs for the `gapir` tool. It runs as a Windows Service and redirects URLs like `http://g/pr/{id}` to full Azure DevOps pull request URLs.

## Code Style & Patterns

### Established Patterns

- **Minimal API Design**: Use ASP.NET Core Minimal APIs for simple routing
- **Dictionary Configuration**: Route mappings stored in Dictionary for easy extension
- **Windows Service Integration**: Built-in service support via Microsoft.Extensions.Hosting.WindowsServices
- **Base62 Encoding**: Shared utility with gapir for compact URL generation
- **Error Handling**: 404 responses with descriptive messages for invalid routes

### Naming Conventions

- **Route Types**: Short, descriptive keys (e.g., "pr" for pull requests)
- **Service Name**: "Kurz URL Redirect Service" for Windows Service registration
- **File Names**: Lowercase with hyphens for scripts (install-service.ps1)

### Architecture Principles

1. **Simplicity First**: Minimal dependencies, straightforward routing
2. **Reliability**: Windows Service for always-available URL resolution
3. **Performance**: Fast startup, efficient redirects, minimal resource usage
4. **Extensibility**: Easy to add new route types via dictionary configuration

## Common Tasks

### Adding New Route Types

Add entries to the route mapping dictionary in Program.cs:

```csharp
var routeMappings = new Dictionary<string, string>
{
    ["pr"] = "https://dev.azure.com/msazure/One/_git/AD-AggregatorService-Workloads/pullrequest/",
    ["wi"] = "https://dev.azure.com/msazure/One/_workitems/edit/"  // New work item route
};
```

### Extending ID Format Support

The service automatically handles both Base64 and decimal IDs:

- Base62: `http://g/pr/OwAc` (compact, preferred)
- Decimal: `http://g/pr/12041652` (backward compatibility)

### Service Management

Development mode:
```powershell
.\install.ps1                    # Console application
```

Production mode:
```powershell
.\install-service.ps1           # Windows Service
.\install-service.ps1 status    # Check status
.\install-service.ps1 uninstall # Remove service
```

## Key Files

- **Program.cs**: Main service logic, routing configuration, Windows Service setup
- **Base62.cs**: Shared encoding utility (also used by gapir)
- **install.ps1**: Developer console setup
- **install-service.ps1**: Production Windows Service deployment
- **test.http**: HTTP client testing scenarios

## Service Architecture

### Core Components

1. **Route Handler**: Single endpoint that handles all `/{routeType}/{id}` requests
2. **Route Mapping**: Dictionary-based configuration for different URL types
3. **ID Processing**: Automatic detection of Base62 vs decimal format
4. **Error Handling**: 404 responses for unsupported routes

### Network Configuration

- **Port**: 80 (requires administrator privileges)
- **Host**: `g` (via hosts file entry `127.0.0.1 g`)
- **Protocol**: HTTP (internal service, no HTTPS needed)

### Integration Points

- **gapir Integration**: Generates Base62 URLs that kurz resolves
- **Shared Base62**: Common encoding logic between services
- **Windows Service**: System-level reliability and auto-start

## Performance Notes

### Optimizations

- Minimal API for fast startup
- Dictionary O(1) lookup for route types
- No database or external dependencies
- HTTP 308 (Permanent Redirect) for browser caching

### Resource Usage

- **Memory**: Very low - minimal framework overhead
- **CPU**: Minimal - simple string operations and redirects
- **Startup Time**: Fast due to minimal dependencies

## Error Handling

### Standard Responses

- **Valid Routes**: 308 Permanent Redirect to target URL
- **Invalid Routes**: 404 Not Found with descriptive message
- **Invalid IDs**: 404 Not Found explaining the issue

### Logging Strategy

- **ASP.NET Core Logging**: Integrated with Windows Event Log when running as service
- **Structured Logging**: Use ILogger for consistent log formatting
- **Error Context**: Include route type and ID in error messages

## Testing Considerations

When adding features:

- Test both Base62 and decimal ID formats
- Verify Windows Service installation and management
- Test error scenarios (invalid routes, malformed IDs)
- Verify hosts file modification and cleanup
- Test integration with gapir URL generation

## Security Model

### Trust Assumptions

- **Internal Service**: No authentication required
- **Localhost Binding**: Not exposed externally
- **Trusted Input**: URLs generated by gapir are trusted

### Input Validation

- **Route Validation**: Dictionary key lookup prevents injection
- **ID Validation**: Automatic via Base62/decimal parsing
- **URL Construction**: Template-based, safe parameter insertion

## Deployment Strategy

### Development

- Console application mode for debugging
- Manual startup and testing
- Direct log output for development

### Production

- Windows Service with automatic startup
- Deployment to Program Files directory
- Service management via PowerShell scripts
- Integration with Windows Service infrastructure

## Future-Proofing

The service is designed for:

- **New Route Types**: Easy addition via dictionary configuration
- **Multiple Organizations**: Could extend route mapping structure
- **Analytics**: Ready for request tracking and metrics
- **Configuration Files**: Could externalize route mappings
- **Load Balancing**: Architecture supports multiple instances

## Common Patterns

### Adding Monitoring

```csharp
app.MapGet("/health", () => "OK");  // Health check endpoint
```

### Extending Configuration

```csharp
// Could load from configuration file
var routeMappings = configuration.GetSection("Routes")
    .Get<Dictionary<string, string>>();
```

### Adding Logging

```csharp
app.Logger.LogInformation("Redirecting {RouteType}/{Id} to {TargetUrl}", 
    routeType, id, targetUrl);
```

This service provides reliable URL shortening while maintaining simplicity and performance for the gapir ecosystem.
